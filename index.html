<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>‚õΩ Gas Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<!-- Supabase UMD bundle ‚Äî exposes window.supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<style>
  :root {
    --bg: #0d0d0d; --surface: #161616; --surface2: #1f1f1f;
    --border: #2a2a2a; --accent: #f5a623; --accent2: #ff6b35;
    --text: #f0f0f0; --muted: #777; --green: #2ecc71; --red: #e74c3c;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; max-width: 480px; margin: 0 auto; }

  #setup-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 30px 24px; text-align: center; }
  #setup-screen h1 { font-family: 'Bebas Neue', sans-serif; font-size: 48px; letter-spacing: 2px; background: linear-gradient(90deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 8px; }
  .sub { color: var(--muted); font-size: 14px; margin-bottom: 28px; line-height: 1.6; }
  #setup-screen .card { width: 100%; text-align: left; }
  #setup-error { color: var(--red); font-size: 13px; margin-bottom: 12px; line-height: 1.5; }
  .hint { font-size: 11px; color: var(--muted); margin-top: -10px; margin-bottom: 14px; }

  header { background: linear-gradient(135deg, #1a1000 0%, #0d0d0d 60%); padding: 28px 20px 20px; border-bottom: 1px solid var(--border); position: relative; overflow: hidden; }
  header::before { content: '‚õΩ'; position: absolute; right: -10px; top: -10px; font-size: 100px; opacity: 0.08; }
  header h1 { font-family: 'Bebas Neue', sans-serif; font-size: 38px; letter-spacing: 2px; background: linear-gradient(90deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; line-height: 1; }
  header p { color: var(--muted); font-size: 13px; margin-top: 4px; }
  .live-dot { display: inline-block; width: 7px; height: 7px; background: var(--green); border-radius: 50%; margin-right: 5px; animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.3} }

  .tabs { display: flex; background: var(--surface); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 10; }
  .tab { flex: 1; padding: 14px 8px; text-align: center; font-size: 12px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; color: var(--muted); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

  .section { display: none; padding: 20px; }
  .section.active { display: block; }

  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 18px; margin-bottom: 14px; }
  .card-title { font-size: 11px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; color: var(--muted); margin-bottom: 12px; }

  .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }
  .stat-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 12px; padding: 16px; text-align: center; }
  .stat-value { font-family: 'Bebas Neue', sans-serif; font-size: 36px; line-height: 1; color: var(--accent); }
  .stat-label { font-size: 11px; color: var(--muted); margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

  .progress-wrap { margin: 6px 0 10px; }
  .progress-label { display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
  .progress-bar { height: 8px; background: var(--border); border-radius: 99px; overflow: hidden; }
  .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2)); border-radius: 99px; transition: width 0.5s; }
  .progress-fill.danger { background: linear-gradient(90deg, var(--accent2), var(--red)); }

  label { display: block; font-size: 12px; color: var(--muted); font-weight: 500; margin-bottom: 6px; letter-spacing: 0.3px; }
  input, select { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 15px; padding: 12px 14px; margin-bottom: 14px; outline: none; transition: border-color 0.2s; }
  input:focus { border-color: var(--accent); }
  input[type=number] { -moz-appearance: textfield; }
  input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; }

  .btn { display: block; width: 100%; padding: 14px; border-radius: 12px; border: none; font-family: 'DM Sans', sans-serif; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; text-decoration: none; text-align: center; }
  .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent2)); color: #000; }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); margin-top: 8px; }
  .btn-sm { display: inline-block; width: auto; padding: 8px 16px; font-size: 13px; border-radius: 8px; }
  .btn-venmo { background: #3d95ce; color: #fff; }
  .btn-apple { background: #000; color: #fff; border: 1px solid #333; }
  .btn-danger { background: transparent; border: 1px solid var(--red); color: var(--red); margin-top: 8px; }

  .log-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid var(--border); }
  .log-item:last-child { border-bottom: none; }
  .log-user { font-weight: 600; font-size: 15px; }
  .log-detail { font-size: 12px; color: var(--muted); margin-top: 2px; }
  .log-cans { font-family: 'Bebas Neue', sans-serif; font-size: 22px; color: var(--accent); line-height: 1; }
  .log-cost { font-size: 12px; color: var(--muted); }
  .log-paid { font-size: 11px; color: var(--green); font-weight: 600; }

  .payment-row { padding: 14px 0; border-bottom: 1px solid var(--border); }
  .payment-row:last-child { border-bottom: none; }
  .payment-amount { font-family: 'Bebas Neue', sans-serif; font-size: 28px; color: var(--accent2); line-height: 1; }
  .pay-btns { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }

  .price-display { display: flex; align-items: baseline; gap: 4px; }
  .price-big { font-family: 'Bebas Neue', sans-serif; font-size: 48px; color: var(--accent); line-height: 1; }
  .price-unit { color: var(--muted); font-size: 13px; }
  .section-heading { font-family: 'Bebas Neue', sans-serif; font-size: 22px; letter-spacing: 1px; color: var(--accent); margin-bottom: 14px; }
  .empty-state { text-align: center; color: var(--muted); padding: 30px 0; font-size: 14px; }
  .empty-state span { display: block; font-size: 36px; margin-bottom: 8px; }

  .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--accent); color: #000; font-weight: 600; font-size: 14px; padding: 12px 24px; border-radius: 99px; transition: transform 0.3s; z-index: 100; white-space: nowrap; }
  .toast.show { transform: translateX(-50%) translateY(0); }
  .toast.error { background: var(--red); color: #fff; }

  .loading { text-align: center; color: var(--muted); padding: 20px; font-size: 13px; }
  .spinner { display: inline-block; width: 18px; height: 18px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; vertical-align: middle; margin-right: 8px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .conn-bar { background: var(--surface2); padding: 6px 20px; font-size: 11px; color: var(--muted); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 6px; }
</style>
</head>
<body>

<!-- SETUP SCREEN -->
<div id="setup-screen">
  <div style="font-size:60px;margin-bottom:12px;">‚õΩ</div>
  <h1>Gas Tracker</h1>
  <p class="sub">Connect your free Supabase database to sync<br>usage across all devices in real time.</p>
  <div class="card">
    <div class="card-title">Supabase Connection</div>
    <label>Project URL</label>
    <input type="url" id="setup-url" placeholder="https://xxxxxxxxxxxx.supabase.co" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
    <label>Anon / Public API Key</label>
    <input type="text" id="setup-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
    <p class="hint">Found in Supabase ‚Üí Project Settings ‚Üí API</p>
    <p id="setup-error"></p>
    <button class="btn btn-primary" id="connect-btn" onclick="connectSupabase()">Connect &amp; Launch App</button>
  </div>
</div>

<!-- MAIN APP -->
<div id="main-app" style="display:none">
  <header>
    <h1>Gas Tracker</h1>
    <p><span class="live-dot"></span>Live ¬∑ shared across all devices</p>
  </header>
  <div class="conn-bar" id="conn-bar"><span class="spinner"></span> Connecting...</div>
  <div class="tabs">
    <div class="tab active" onclick="switchTab('dashboard')">Dashboard</div>
    <div class="tab" onclick="switchTab('log')">Log Use</div>
    <div class="tab" onclick="switchTab('pay')">Payments</div>
    <div class="tab" onclick="switchTab('admin')">Admin</div>
  </div>

  <div id="tab-dashboard" class="section active">
    <div class="stats-row">
      <div class="stat-card"><div class="stat-value" id="stat-remaining">‚Äî</div><div class="stat-label">Cans Left</div></div>
      <div class="stat-card"><div class="stat-value" id="stat-used">0</div><div class="stat-label">Cans Used</div></div>
    </div>
    <div class="card">
      <div class="card-title">Daily Inventory</div>
      <div class="progress-wrap">
        <div class="progress-label"><span id="progress-label-left">Loading...</span><span id="progress-label-right">0%</span></div>
        <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
      </div>
      <div class="price-display" style="margin-top:10px;">
        <div class="price-big" id="dash-price">$‚Äî</div>
        <div class="price-unit">per gallon ¬∑ 5 gal/can</div>
      </div>
      <p style="font-size:12px;color:var(--muted);margin-top:6px;">Cost per can: <strong style="color:var(--text)" id="dash-cost-per-can">$‚Äî</strong></p>
    </div>
    <div class="card">
      <div class="card-title">Today's Usage ‚Äî Live üî¥</div>
      <div id="dash-log"><div class="loading"><span class="spinner"></span>Loading...</div></div>
    </div>
  </div>

  <div id="tab-log" class="section">
    <div class="section-heading">Log Gas Usage</div>
    <div class="card">
      <label>Your Name</label>
      <input type="text" id="log-name" placeholder="e.g. Mike" />
      <label>Number of Cans Used</label>
      <input type="number" id="log-cans" placeholder="1" min="1" step="1" />
      <label>Date</label>
      <input type="date" id="log-date" />
      <label>Notes (optional)</label>
      <input type="text" id="log-notes" placeholder="e.g. generator, lawn mower..." />
      <button class="btn btn-primary" id="log-btn" onclick="logUsage()">Log Usage</button>
    </div>
    <div class="card">
      <div class="card-title">All Recent Entries (Everyone)</div>
      <div id="recent-entries"><div class="loading"><span class="spinner"></span>Loading...</div></div>
    </div>
  </div>

  <div id="tab-pay" class="section">
    <div class="section-heading">What's Owed</div>
    <div class="card" style="border-color:rgba(245,166,35,0.3)">
      <div class="card-title">Payment Info</div>
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div><div style="font-size:12px;color:var(--muted)">Gas Buyer</div><div style="font-weight:600;font-size:16px" id="pay-buyer-name">Not set</div></div>
        <div style="text-align:right"><div style="font-size:12px;color:var(--muted)">Venmo</div><div style="font-weight:600;font-size:14px;color:#3d95ce" id="pay-venmo-handle">Not set</div></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Amounts Owed (Unpaid)</div>
      <div id="payment-list"><div class="loading"><span class="spinner"></span>Loading...</div></div>
    </div>
  </div>

  <div id="tab-admin" class="section">
    <div class="section-heading">Admin Settings</div>
    <div class="card">
      <div class="card-title">Daily Setup</div>
      <label>Starting Cans Per Day</label>
      <input type="number" id="admin-cans" placeholder="10" min="1" />
      <label>Price Per Gallon ($)</label>
      <input type="number" id="admin-price" placeholder="3.50" step="0.01" min="0" />
      <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
    </div>
    <div class="card">
      <div class="card-title">Gas Buyer / Payment Info</div>
      <label>Buyer's Name</label>
      <input type="text" id="admin-buyer-name" placeholder="e.g. John" />
      <label>Venmo Handle (without @)</label>
      <input type="text" id="admin-venmo" placeholder="e.g. john-smith-99" />
      <label>Apple Pay / Phone Number (optional)</label>
      <input type="tel" id="admin-phone" placeholder="e.g. 555-555-5555" />
      <button class="btn btn-primary" onclick="saveBuyerInfo()">Save Buyer Info</button>
    </div>
    <div class="card">
      <div class="card-title">Danger Zone</div>
      <button class="btn btn-outline" style="color:var(--muted);border-style:dashed" onclick="resetDay()">üîÑ Reset Today's Usage</button>
      <button class="btn btn-danger" onclick="clearAll()">üóëÔ∏è Clear All Data</button>
    </div>
    <div class="card">
      <div class="card-title">Connection</div>
      <button class="btn btn-outline" onclick="disconnectSupabase()">üîå Change Supabase Connection</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// sb = our supabase client instance
// window.supabase = the library loaded from the CDN script tag above
let sb = null;
let settings = { startingCans: 10, pricePerGallon: 3.50, buyerName: '', venmoHandle: '', buyerPhone: '' };
let realtimeSub = null;

function setSetupError(msg) {
  document.getElementById('setup-error').textContent = msg;
}

async function connectSupabase(savedUrl, savedKey) {
  const url = (savedUrl || document.getElementById('setup-url').value).trim();
  const key = (savedKey || document.getElementById('setup-key').value).trim();

  if (!url || !key) { setSetupError('Please enter both the Project URL and API key.'); return; }
  if (!url.startsWith('https://')) { setSetupError('URL must start with https://'); return; }

  const btn = document.getElementById('connect-btn');
  btn.disabled = true;
  btn.textContent = 'Connecting‚Ä¶';
  setSetupError('');

  try {
    // The UMD bundle puts createClient on window.supabase
    sb = window.supabase.createClient(url, key);

    // Test ‚Äî PGRST116 means "no rows" which is fine, the table just exists & is empty
    const { error } = await sb.from('settings').select('id').limit(1);
    if (error && error.code !== 'PGRST116') throw new Error(error.message);

    localStorage.setItem('sb_url', url);
    localStorage.setItem('sb_key', key);
    launchApp();

  } catch (e) {
    console.error(e);
    let msg = 'Connection failed. ';
    if (!e.message) {
      msg += 'Check your URL and key.';
    } else if (e.message.includes('Failed to fetch') || e.message.includes('NetworkError')) {
      msg += 'Cannot reach Supabase ‚Äî double-check the Project URL.';
    } else if (e.message.toLowerCase().includes('api key') || e.message.includes('401')) {
      msg += 'Invalid API key ‚Äî use the anon/public key from Project Settings ‚Üí API.';
    } else if (e.message.includes('does not exist') || e.message.includes('relation')) {
      msg += 'Tables not found. Did you run the SQL in Step 2 of the setup guide?';
    } else {
      msg += e.message;
    }
    setSetupError(msg);
    btn.disabled = false;
    btn.textContent = 'Connect & Launch App';
  }
}

function disconnectSupabase() {
  if (!confirm('Disconnect and re-enter credentials?')) return;
  if (realtimeSub && sb) sb.removeChannel(realtimeSub);
  localStorage.removeItem('sb_url');
  localStorage.removeItem('sb_key');
  sb = null;
  document.getElementById('main-app').style.display = 'none';
  document.getElementById('setup-screen').style.display = 'flex';
}

function launchApp() {
  document.getElementById('setup-screen').style.display = 'none';
  document.getElementById('main-app').style.display = 'block';
  document.getElementById('log-date').value = todayStr();
  loadSettings();
  renderDashboard();
  subscribeRealtime();
}

function subscribeRealtime() {
  realtimeSub = sb.channel('gas_tracker')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'gas_entries' }, () => {
      renderDashboard();
      renderRecentEntries();
      renderPayments();
    })
    .on('postgres_changes', { event: '*', schema: 'public', table: 'settings' }, () => loadSettings())
    .subscribe((status) => {
      const bar = document.getElementById('conn-bar');
      bar.innerHTML = status === 'SUBSCRIBED'
        ? '<span class="live-dot"></span> Live ‚Äî changes sync to all devices instantly'
        : '<span class="spinner"></span> ' + status + '‚Ä¶';
    });
}

async function loadSettings() {
  const { data } = await sb.from('settings').select('*').eq('id', 1).maybeSingle();
  if (data) {
    settings = {
      startingCans: data.starting_cans || 10,
      pricePerGallon: parseFloat(data.price_per_gallon) || 3.50,
      buyerName: data.buyer_name || '',
      venmoHandle: data.venmo_handle || '',
      buyerPhone: data.buyer_phone || ''
    };
    renderDashboard();
  }
}

async function saveSettings() {
  const cans = parseInt(document.getElementById('admin-cans').value);
  const price = parseFloat(document.getElementById('admin-price').value);
  if (!cans || cans < 1 || isNaN(price) || price < 0) { showToast('‚ö†Ô∏è Check values', true); return; }
  const { error } = await sb.from('settings').upsert({ id: 1, starting_cans: cans, price_per_gallon: price, buyer_name: settings.buyerName, venmo_handle: settings.venmoHandle, buyer_phone: settings.buyerPhone });
  if (error) { showToast('‚ùå ' + error.message, true); return; }
  showToast('‚úÖ Settings saved!');
  loadSettings();
}

async function saveBuyerInfo() {
  const buyerName = document.getElementById('admin-buyer-name').value.trim();
  const venmo = document.getElementById('admin-venmo').value.trim().replace('@', '');
  const phone = document.getElementById('admin-phone').value.trim();
  const { error } = await sb.from('settings').upsert({ id: 1, starting_cans: settings.startingCans, price_per_gallon: settings.pricePerGallon, buyer_name: buyerName, venmo_handle: venmo, buyer_phone: phone });
  if (error) { showToast('‚ùå ' + error.message, true); return; }
  showToast('‚úÖ Buyer info saved!');
  loadSettings();
}

function costPerCan() { return settings.pricePerGallon * 5; }
function todayStr() { return new Date().toISOString().slice(0, 10); }
function fmtDate(d) { return new Date(d + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); }

function showToast(msg, isError = false) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show' + (isError ? ' error' : '');
  setTimeout(() => t.className = 'toast', 2800);
}

function switchTab(id) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  ['dashboard', 'log', 'pay', 'admin'].forEach((name, i) => {
    if (name === id) document.querySelectorAll('.tab')[i].classList.add('active');
  });
  document.getElementById('tab-' + id).classList.add('active');
  if (id === 'dashboard') renderDashboard();
  if (id === 'pay') renderPayments();
  if (id === 'log') renderRecentEntries();
  if (id === 'admin') populateAdmin();
}

async function renderDashboard() {
  if (!sb) return;
  const { data: entries } = await sb.from('gas_entries').select('*').eq('entry_date', todayStr());
  const usedCans = (entries || []).reduce((s, e) => s + e.cans, 0);
  const remaining = Math.max(0, settings.startingCans - usedCans);
  const pct = settings.startingCans > 0 ? (usedCans / settings.startingCans) * 100 : 0;
  document.getElementById('stat-remaining').textContent = remaining;
  document.getElementById('stat-used').textContent = usedCans;
  document.getElementById('progress-label-left').textContent = `${usedCans} of ${settings.startingCans} cans used`;
  document.getElementById('progress-label-right').textContent = Math.round(pct) + '%';
  const fill = document.getElementById('progress-fill');
  fill.style.width = Math.min(pct, 100) + '%';
  fill.className = 'progress-fill' + (pct >= 80 ? ' danger' : '');
  document.getElementById('dash-price').textContent = '$' + settings.pricePerGallon.toFixed(2);
  document.getElementById('dash-cost-per-can').textContent = '$' + costPerCan().toFixed(2);
  const logEl = document.getElementById('dash-log');
  if (!entries || entries.length === 0) {
    logEl.innerHTML = '<div class="empty-state"><span>‚õΩ</span>No usage logged yet today</div>';
  } else {
    logEl.innerHTML = entries.map(e => `
      <div class="log-item">
        <div><div class="log-user">${e.user_name}</div><div class="log-detail">${e.notes || 'No notes'}</div></div>
        <div style="text-align:right">
          <div class="log-cans">${e.cans} can${e.cans !== 1 ? 's' : ''}</div>
          <div class="log-cost">$${(e.cans * costPerCan()).toFixed(2)}</div>
          ${e.paid ? '<div class="log-paid">‚úì PAID</div>' : ''}
        </div>
      </div>`).join('');
  }
}

async function logUsage() {
  const name = document.getElementById('log-name').value.trim();
  const cans = parseInt(document.getElementById('log-cans').value);
  const date = document.getElementById('log-date').value;
  const notes = document.getElementById('log-notes').value.trim();
  if (!name) { showToast('‚ö†Ô∏è Enter your name', true); return; }
  if (!cans || cans < 1) { showToast('‚ö†Ô∏è Enter valid can count', true); return; }
  if (!date) { showToast('‚ö†Ô∏è Select a date', true); return; }
  const { data: todayEntries } = await sb.from('gas_entries').select('cans').eq('entry_date', date);
  const usedToday = (todayEntries || []).reduce((s, e) => s + e.cans, 0);
  if (usedToday + cans > settings.startingCans) { showToast(`‚ö†Ô∏è Only ${settings.startingCans - usedToday} cans left!`, true); return; }
  const btn = document.getElementById('log-btn');
  btn.disabled = true; btn.textContent = 'Saving‚Ä¶';
  const { error } = await sb.from('gas_entries').insert({ user_name: name, cans, entry_date: date, notes: notes || null, paid: false });
  btn.disabled = false; btn.textContent = 'Log Usage';
  if (error) { showToast('‚ùå ' + error.message, true); return; }
  document.getElementById('log-name').value = '';
  document.getElementById('log-cans').value = '';
  document.getElementById('log-notes').value = '';
  showToast('‚úÖ Usage logged!');
  renderRecentEntries();
  renderDashboard();
}

async function renderRecentEntries() {
  const el = document.getElementById('recent-entries');
  el.innerHTML = '<div class="loading"><span class="spinner"></span>Loading‚Ä¶</div>';
  const { data: entries } = await sb.from('gas_entries').select('*').order('created_at', { ascending: false }).limit(20);
  if (!entries || entries.length === 0) { el.innerHTML = '<div class="empty-state"><span>üìã</span>No entries yet</div>'; return; }
  el.innerHTML = entries.map(e => `
    <div class="log-item">
      <div><div class="log-user">${e.user_name}</div><div class="log-detail">${fmtDate(e.entry_date)}${e.notes ? ' ¬∑ ' + e.notes : ''}</div></div>
      <div style="text-align:right">
        <div class="log-cans">${e.cans} can${e.cans !== 1 ? 's' : ''}</div>
        <div class="log-cost">$${(e.cans * costPerCan()).toFixed(2)}</div>
        ${e.paid ? '<div class="log-paid">‚úì PAID</div>' : ''}
      </div>
    </div>`).join('');
}

async function renderPayments() {
  document.getElementById('pay-buyer-name').textContent = settings.buyerName || 'Not set';
  document.getElementById('pay-venmo-handle').textContent = settings.venmoHandle ? '@' + settings.venmoHandle : 'Not set';
  const el = document.getElementById('payment-list');
  el.innerHTML = '<div class="loading"><span class="spinner"></span>Loading‚Ä¶</div>';
  const { data: unpaid } = await sb.from('gas_entries').select('*').eq('paid', false);
  const byUser = {};
  (unpaid || []).forEach(e => {
    if (!byUser[e.user_name]) byUser[e.user_name] = { cans: 0, cost: 0 };
    byUser[e.user_name].cans += e.cans;
    byUser[e.user_name].cost += e.cans * costPerCan();
  });
  const users = Object.keys(byUser);
  if (users.length === 0) { el.innerHTML = '<div class="empty-state"><span>‚úÖ</span>All paid up!</div>'; return; }
  el.innerHTML = users.map(name => {
    const { cans, cost } = byUser[name];
    const note = encodeURIComponent(`Gas - ${cans} can${cans !== 1 ? 's' : ''}`);
    const venmoLink = settings.venmoHandle ? `https://venmo.com/${settings.venmoHandle}?txn=pay&amount=${cost.toFixed(2)}&note=${note}` : null;
    const appleLink = settings.buyerPhone ? `sms:${settings.buyerPhone}&body=${encodeURIComponent(`Sending $${cost.toFixed(2)} for gas (${cans} cans) ‚Äî via Apple Pay`)}` : null;
    return `
      <div class="payment-row">
        <div style="display:flex;align-items:center;gap:10px">
          <div class="payment-amount">$${cost.toFixed(2)}</div>
          <div><div style="font-weight:600;font-size:15px">${name}</div><div style="font-size:12px;color:var(--muted)">${cans} can${cans !== 1 ? 's' : ''} ¬∑ ${cans * 5} gal</div></div>
        </div>
        <div class="pay-btns">
          ${venmoLink ? `<a href="${venmoLink}" target="_blank" class="btn btn-sm btn-venmo">üíô Venmo</a>` : ''}
          ${appleLink ? `<a href="${appleLink}" class="btn btn-sm btn-apple"> Apple Pay</a>` : ''}
          <button class="btn btn-sm btn-outline" onclick="markPaid('${name.replace(/'/g, "\\'")}')">‚úì Mark Paid</button>
        </div>
      </div>`;
  }).join('');
}

async function markPaid(name) {
  const { error } = await sb.from('gas_entries').update({ paid: true }).eq('user_name', name).eq('paid', false);
  if (error) { showToast('‚ùå ' + error.message, true); return; }
  showToast(`‚úÖ ${name} marked as paid`);
  renderPayments();
}

function populateAdmin() {
  document.getElementById('admin-cans').value = settings.startingCans;
  document.getElementById('admin-price').value = settings.pricePerGallon;
  document.getElementById('admin-buyer-name').value = settings.buyerName;
  document.getElementById('admin-venmo').value = settings.venmoHandle;
  document.getElementById('admin-phone').value = settings.buyerPhone;
}

async function resetDay() {
  if (!confirm("Delete all of today's entries?")) return;
  const { error } = await sb.from('gas_entries').delete().eq('entry_date', todayStr());
  if (error) { showToast('‚ùå ' + error.message, true); return; }
  renderDashboard();
  showToast('üîÑ Today reset');
}

async function clearAll() {
  if (!confirm('Delete ALL entries permanently? This cannot be undone.')) return;
  const { error } = await sb.from('gas_entries').delete().gte('id', 0);
  if (error) { showToast('‚ùå ' + error.message, true); return; }
  renderDashboard();
  renderRecentEntries();
  showToast('üóëÔ∏è All data cleared');
}

// Auto-connect if saved from previous visit
const savedUrl = localStorage.getItem('sb_url');
const savedKey = localStorage.getItem('sb_key');
if (savedUrl && savedKey) connectSupabase(savedUrl, savedKey);
</script>
</body>
</html>
